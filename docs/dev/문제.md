원인
4명이 동시에 join 하면서 대기 방이 2개 생기고, 봇이 방마다 2명씩 들어가 있었습니다.
한 방에 4명이 모이지 않아 all_submitted가 되지 않고, 라운드가 적용되지 않아 계속 round=1만 나왔습니다.
수정 사항
1. app/models/game.py
타입별 대기 방 1개만 허용하는 partial unique index 추가
PostgreSQL: (type) WHERE status = 'waiting'
SQLite: 동일 조건
같은 타입으로 대기 방이 2개 이상 생기지 않도록 했습니다.
2. app/services/game_service.py
새 방 생성 시 IntegrityError (위 unique 위반) 나면 rollback 후
이미 생성된 대기 방을 한 번 더 조회해서 그 방을 반환하도록 했습니다.
동시에 여러 요청이 “방 만들기”를 시도해도, 한 개만 생성되고 나머지는 그 방을 쓰게 됩니다.
3. 해야 할 일 (기존 DB를 그대로 쓰는 경우)
옵션 A – DB 초기화 후 재시작 (권장)
PostgreSQL: docker-compose down -v 후 다시 up
SQLite: backend/*.db 파일 삭제 후 서버 재시작
→ create_all()로 테이블이 다시 만들어지면서 새 인덱스도 같이 생성됩니다.
옵션 B – 인덱스만 수동 추가
PostgreSQL:
  CREATE UNIQUE INDEX ix_games_one_waiting_per_type ON games (type) WHERE status = 'waiting';
SQLite:
  CREATE UNIQUE INDEX ix_games_one_waiting_per_type_sqlite ON games (type) WHERE status = 'waiting';
위 중 하나 적용한 뒤 서버를 다시 띄우고, test_run.py를 다시 실행해 보시면 4명이 한 방에 모여서 round가 2, 3, …으로 진행될 것입니다.